<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل حضور وانصراف - صيدلية د. لؤة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&family=Amiri:wght@400;700&family=Cairo:wght@600;700;800&family=Rakkas&family=Lalezar&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Tajawal", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .hidden {
            display: none;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        .ticket-font-title {
            font-family: 'Amiri', serif;
            font-weight: 700;
        }
        
        .ticket-font-body {
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }
        
        .card-shadow {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        input[type="radio"]:checked + .radio-option {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        input[id="attendanceRadio"]:checked + .radio-option {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
        }
        
        input[id="departureRadio"]:checked + .radio-option {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-color: #ef4444;
            color: white;
        }
        
        .radio-option {
            transition: all 0.3s ease;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-generate:active {
            transform: translateY(0);
        }
        
        .success-message {
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .input-focus {
            transition: all 0.3s ease;
        }
        
        .input-focus:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        /* تحسين شكل البطاقة المصدرة */
        .compact-ticket {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 3px solid #3b82f6;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .watermark-bg {
            background: linear-gradient(45deg, transparent 30%, rgba(59, 130, 246, 0.03) 50%, transparent 70%);
        }
        
        /* علامة مائية معقدة */
        .complex-watermark {
            position: absolute;
            inset: 0;
            overflow: hidden;
            opacity: 0.08;
            pointer-events: none;
            z-index: 1;
        }
        
        .watermark-text {
            position: absolute;
            font-family: 'Scheherazade New', serif;
            font-weight: 700;
            font-size: 50px;
            color: #3b82f6;
            white-space: nowrap;
            transform-origin: center;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .watermark-1 {
            top: 15%;
            left: 50%;
            transform: translateX(-50%) rotate(-25deg);
        }
        
        .watermark-2 {
            top: 45%;
            left: 50%;
            transform: translateX(-50%) rotate(25deg);
            font-size: 42px;
        }
        
        .watermark-3 {
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%) rotate(-25deg);
            font-size: 40px;
        }
        
        /* خط الوقت المعقد */
        .secure-time {
            font-family: 'Rakkas', cursive;
            font-size: 19px;
            font-weight: 900;
            letter-spacing: 3px;
            text-shadow: 2px 2px 1px rgba(5, 150, 105, 0.2),
                         -1px -1px 1px rgba(5, 150, 105, 0.15),
                         0 0 10px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, #059669 0%, #047857 30%, #10b981 60%, #065f46 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            transform: skewX(-3deg);
            display: inline-block;
            filter: drop-shadow(0 1px 2px rgba(5, 150, 105, 0.4));
        }
        
        /* نقط دقيقة خلفية للبطاقة */
        .micro-pattern {
            position: absolute;
            inset: 0;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(59, 130, 246, 0.02) 10px, rgba(59, 130, 246, 0.02) 20px),
                repeating-linear-gradient(-45deg, transparent, transparent 10px, rgba(147, 51, 234, 0.02) 10px, rgba(147, 51, 234, 0.02) 20px);
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="max-w-md w-full bg-white p-8 rounded-3xl card-shadow">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-block p-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4">
                <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
            </div>
            <h1 class="text-4xl font-black text-gray-800 mb-2">صيدلية د. لؤة</h1>
        </div>

        <!-- Form -->
        <div class="space-y-6">
            <!-- اسم الموظف -->
            <div>
                <label for="employeeNameInput" class="block text-lg font-bold text-gray-700 mb-3">
                    <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    اسم الموظف
                </label>
                <input type="text" id="employeeNameInput" placeholder="اكتب اسمك هنا..." 
                    class="input-focus w-full p-4 border-2 border-gray-300 rounded-xl text-lg focus:ring-0 focus:border-blue-500 focus:outline-none">
            </div>
            
            <!-- نوع التسجيل -->
            <div>
                <label class="block text-lg font-bold text-gray-700 mb-3">
                    <svg class="w-5 h-5 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    نوع التسجيل
                </label>
                <div class="grid grid-cols-2 gap-4">
                    <label for="attendanceRadio" class="cursor-pointer">
                        <input type="radio" name="recordType" id="attendanceRadio" value="حضور" class="sr-only">
                        <div class="radio-option p-5 bg-gray-50 border-3 border-gray-300 rounded-xl text-center font-bold text-lg">
                            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            حضور
                        </div>
                    </label>
                    <label for="departureRadio" class="cursor-pointer">
                        <input type="radio" name="recordType" id="departureRadio" value="انصراف" class="sr-only">
                        <div class="radio-option p-5 bg-gray-50 border-3 border-gray-300 rounded-xl text-center font-bold text-lg">
                            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            انصراف
                        </div>
                    </label>
                </div>
            </div>

            <!-- زر التسجيل -->
            <button id="generateButton" class="btn-generate w-full text-white font-bold text-xl p-5 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-300">
                <svg class="w-6 h-6 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                </svg>
                تسجيل ومشاركة
            </button>
            
            <!-- ملاحظة الموقع -->
            <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-xs text-blue-700 text-center font-medium">
                    📍 سيتم طلب الوصول لموقعك لتسجيله في البطاقة
                </p>
            </div>
        </div>

        <!-- منطقة المخرجات -->
        <div id="outputArea" class="mt-8">
            <!-- مؤشر التحميل -->
            <div id="loadingSpinner" class="hidden flex flex-col items-center justify-center py-8">
                <div class="spinner mb-4"></div>
                <p id="loadingText" class="text-gray-700 font-bold text-lg">جاري إنشاء البطاقة...</p>
            </div>
            
            <!-- رسالة الحالة -->
            <div id="statusMessage" class="hidden rounded-xl p-4 text-center font-bold"></div>
            
            <!-- حاوية الصورة -->
            <div id="imageContainer" class="hidden">
                <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-xl">
                    <img id="generatedImage" class="w-full rounded-lg shadow-lg border-2 border-gray-200" alt="بطاقة الحضور">
                    <p class="mt-4 text-sm text-gray-600 text-center font-medium">
                        ✅ تم إنشاء البطاقة بنجاح<br>
                        اضغط مطولاً على الصورة لحفظها أو مشاركتها
                    </p>
                </div>
            </div>
        </div>

        <!-- البطاقة المخفية (قالب الصورة) -->
        <div id="attendanceTicketWrapper" style="position: absolute; left: -9999px; top: -9999px;">
            <div id="attendanceTicket" class="compact-ticket" style="width: 450px; padding: 25px; position: relative;">
                
                <!-- نقط دقيقة خلفية -->
                <div class="micro-pattern rounded-2xl"></div>
                
                <!-- الخلفية المائية -->
                <div class="watermark-bg absolute inset-0 rounded-2xl opacity-40 pointer-events-none"></div>
                
                <!-- علامات مائية معقدة متعددة -->
                <div class="complex-watermark">
                    <div class="watermark-text watermark-1">صيدلية د. لؤة • أصلية</div>
                    <div class="watermark-text watermark-2">⚕️ موثقة رسمياً ⚕️</div>
                    <div class="watermark-text watermark-3">Dr. Loaa Pharmacy</div>
                </div>
                
                <!-- المحتوى -->
                <div class="relative z-10">
                    <!-- العنوان فقط -->
                    <div class="text-center mb-5 pb-3 border-b-2 border-blue-200">
                        <h3 class="ticket-font-title text-2xl font-black text-gray-800">
                            صيدلية د. لؤة
                        </h3>
                    </div>
                    
                    <!-- البيانات -->
                    <div class="space-y-2.5 ticket-font-body">
                        <!-- الاسم -->
                        <div class="flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 p-3 rounded-lg border-r-4 border-blue-500">
                            <span class="font-bold text-gray-700 text-base">👤 الاسم:</span>
                            <span id="ticketName" class="font-black text-gray-900 text-lg"></span>
                        </div>
                        
                        <!-- نوع التسجيل -->
                        <div id="ticketTypeRow" class="flex items-center justify-between p-3 rounded-lg border-r-4">
                            <span class="font-bold text-gray-700 text-base">📋 التسجيل:</span>
                            <span id="ticketType" class="font-black text-lg"></span>
                        </div>
                        
                        <!-- التاريخ -->
                        <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50 p-3 rounded-lg border-r-4 border-purple-500">
                            <span class="font-bold text-gray-700 text-base">📅 التاريخ:</span>
                            <span id="ticketDate" class="font-black text-gray-900 text-base"></span>
                        </div>
                        
                        <!-- الوقت -->
                        <div class="flex items-center justify-between bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border-r-4 border-green-500">
                            <span class="font-bold text-gray-700 text-base">🕐 الوقت:</span>
                            <span id="ticketTime" class="secure-time font-black"></span>
                        </div>
                        
                        <!-- الموقع الجغرافي -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border-r-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-gray-700 text-base">📍 الموقع:</span>
                                <span id="ticketLocation" class="font-bold text-orange-900 text-xs text-left" style="max-width: 60%; direction: ltr;"></span>
                            </div>
                        </div>
                        
                        <!-- رقم الأمان الفريد -->
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500 font-semibold">🔒 رقم التحقق:</span>
                                <span id="securityCode" class="text-xs font-mono font-bold text-blue-700 tracking-wider"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // عناصر الواجهة
            const employeeNameInput = document.getElementById('employeeNameInput');
            const generateButton = document.getElementById('generateButton');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const statusMessage = document.getElementById('statusMessage');
            const imageContainer = document.getElementById('imageContainer');
            const generatedImage = document.getElementById('generatedImage');
            
            // عناصر البطاقة
            const attendanceTicketWrapper = document.getElementById('attendanceTicketWrapper');
            const ticketName = document.getElementById('ticketName');
            const ticketDate = document.getElementById('ticketDate');
            const ticketTime = document.getElementById('ticketTime');
            const ticketType = document.getElementById('ticketType');
            const ticketTypeRow = document.getElementById('ticketTypeRow');
            const securityCode = document.getElementById('securityCode');
            const ticketLocation = document.getElementById('ticketLocation');
            
            // دالة توليد رقم أمان فريد
            function generateSecurityCode() {
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 10000);
                const hash = (timestamp + random).toString(36).toUpperCase();
                return `LU-${hash.substring(0, 4)}-${hash.substring(4, 8)}`;
            }
            
            // دالة الحصول على الموقع الجغرافي
            async function getLocation() {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) {
                        resolve({ text: 'غير متاح', coords: null });
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const lat = position.coords.latitude.toFixed(4);
                            const lon = position.coords.longitude.toFixed(4);
                            
                            // محاولة الحصول على اسم المكان من API
                            try {
                                const response = await fetch(
                                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ar&zoom=18`,
                                    { headers: { 'User-Agent': 'AttendanceSystem/1.0' } }
                                );
                                const data = await response.json();
                                
                                // استخراج معلومات الموقع بالترتيب
                                const addr = data.address || {};
                                const road = addr.road || addr.street || '';
                                const suburb = addr.suburb || addr.neighbourhood || addr.quarter || '';
                                const city = addr.city || addr.town || addr.village || '';
                                const state = addr.state || '';
                                
                                // بناء نص الموقع
                                let parts = [];
                                if (road) parts.push(road);
                                if (suburb && suburb !== city) parts.push(suburb);
                                if (city) parts.push(city);
                                
                                let locationText = parts.length > 0 ? parts.join(', ') : `${lat}, ${lon}`;
                                
                                // اختصار النص إذا كان طويلاً
                                if (locationText.length > 45) {
                                    locationText = locationText.substring(0, 42) + '...';
                                }
                                
                                resolve({ text: locationText, coords: `${lat}, ${lon}` });
                            } catch (error) {
                                // في حالة فشل API، استخدم الإحداثيات فقط
                                console.error('API Error:', error);
                                resolve({ text: `${lat}, ${lon}`, coords: `${lat}, ${lon}` });
                            }
                        },
                        (error) => {
                            // في حالة رفض المستخدم أو فشل الوصول
                            console.error('خطأ في الموقع:', error);
                            resolve({ text: 'غير محدد', coords: null });
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            }

            // دالة عرض رسالة الحالة
            function showStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = 'rounded-xl p-4 text-center font-bold';
                
                if (type === 'error') {
                    statusMessage.classList.add('bg-red-100', 'text-red-800', 'border-2', 'border-red-300');
                } else if (type === 'success') {
                    statusMessage.classList.add('bg-green-100', 'text-green-800', 'border-2', 'border-green-300', 'success-message');
                } else {
                    statusMessage.classList.add('bg-blue-100', 'text-blue-800', 'border-2', 'border-blue-300');
                }
                
                statusMessage.classList.remove('hidden');
                
                // إخفاء الرسالة بعد 5 ثواني
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 5000);
            }

            // دالة إنشاء البطاقة
            generateButton.addEventListener('click', async () => {
                // إخفاء العناصر السابقة
                statusMessage.classList.add('hidden');
                imageContainer.classList.add('hidden');
                
                // التحقق من الاسم
                const name = employeeNameInput.value.trim();
                if (!name) {
                    showStatus('⚠️ الرجاء إدخال اسم الموظف أولاً', 'error');
                    employeeNameInput.focus();
                    return;
                }
                
                // التحقق من نوع التسجيل
                const recordTypeRadio = document.querySelector('input[name="recordType"]:checked');
                if (!recordTypeRadio) {
                    showStatus('⚠️ الرجاء اختيار نوع التسجيل (حضور أو انصراف)', 'error');
                    return;
                }
                
                const recordType = recordTypeRadio.value;
                
                // إظهار مؤشر التحميل
                const loadingText = document.getElementById('loadingText');
                loadingSpinner.classList.remove('hidden');
                loadingText.textContent = '📍 جاري تحديد موقعك...';
                
                try {
                    // الحصول على الموقع الجغرافي أولاً
                    const location = await getLocation();
                    loadingText.textContent = '✨ جاري إنشاء البطاقة...';
                    // الحصول على التاريخ والوقت
                    const now = new Date();
                    const timeOptions = { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: true, 
                        timeZone: 'Africa/Cairo', 
                        numberingSystem: 'latn' 
                    };
                    const dateOptions = { 
                        year: 'numeric', 
                        month: 'numeric', 
                        day: 'numeric', 
                        weekday: 'long',
                        timeZone: 'Africa/Cairo', 
                        numberingSystem: 'latn' 
                    };
                    
                    const time = now.toLocaleTimeString('ar-EG', timeOptions);
                    const date = now.toLocaleDateString('ar-EG', dateOptions);
                    const securityNumber = generateSecurityCode();
                    const locationText = location.text;

                    // تحديث بيانات البطاقة
                    ticketName.textContent = name;
                    ticketDate.textContent = date;
                    ticketTime.textContent = time;
                    ticketType.textContent = recordType;
                    securityCode.textContent = securityNumber;
                    ticketLocation.textContent = locationText;
                    
                    // تغيير تنسيق نوع التسجيل
                    ticketTypeRow.className = 'flex items-center justify-between p-3 rounded-lg border-r-4';
                    ticketType.className = 'font-black text-lg';
                    
                    if (recordType === 'حضور') {
                        ticketTypeRow.classList.add('bg-gradient-to-r', 'from-green-50', 'to-emerald-50', 'border-green-500');
                        ticketType.classList.add('text-green-800');
                    } else {
                        ticketTypeRow.classList.add('bg-gradient-to-r', 'from-red-50', 'to-rose-50', 'border-red-500');
                        ticketType.classList.add('text-red-800');
                    }

                    // انتظار قصير لتحميل الخطوط
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // إنشاء الصورة باستخدام html2canvas
                    const canvas = await html2canvas(attendanceTicketWrapper, { 
                        scale: 3, // جودة عالية جداً
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        width: 450
                    });
                    
                    // تحويل إلى blob
                    canvas.toBlob(async (blob) => {
                        if (!blob) {
                            throw new Error('فشل في تحويل الصورة');
                        }
                        
                        const fileName = `حضور_${name}_${new Date().getTime()}.png`;
                        const file = new File([blob], fileName, { type: 'image/png' });
                        
                        // محاولة المشاركة
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            const shareData = {
                                files: [file],
                                title: `بطاقة ${recordType} - ${name}`,
                                text: `إثبات ${recordType}\nالموظف: ${name}\n${date} - ${time}\nالموقع: ${locationText}`
                            };
                            
                            try {
                                await navigator.share(shareData);
                                loadingSpinner.classList.add('hidden');
                                showStatus('✅ تمت المشاركة بنجاح!', 'success');
                            } catch (err) {
                                if (err.name === 'AbortError') {
                                    // ألغى المستخدم المشاركة
                                    loadingSpinner.classList.add('hidden');
                                    showStatus('❌ تم إلغاء المشاركة', 'error');
                                } else {
                                    throw err;
                                }
                            }
                        } else {
                            // عرض الصورة كبديل
                            throw new Error('المشاركة غير مدعومة');
                        }
                        
                    }, 'image/png', 1.0);

                } catch (err) {
                    console.error('خطأ:', err);
                    
                    // عرض الصورة في الصفحة كحل بديل
                    try {
                        const canvas = await html2canvas(attendanceTicketWrapper, { 
                            scale: 3,
                            useCORS: true,
                            backgroundColor: '#ffffff',
                            logging: false
                        });
                        
                        generatedImage.src = canvas.toDataURL('image/png', 1.0);
                        imageContainer.classList.remove('hidden');
                        showStatus('ℹ️ المشاركة غير متاحة. يمكنك حفظ الصورة يدوياً', 'info');
                    } catch (canvasErr) {
                        showStatus('❌ حدث خطأ أثناء إنشاء الصورة', 'error');
                    }
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });

            // تحسين تجربة المستخدم - Enter للتسجيل
            employeeNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    generateButton.click();
                }
            });
        });
    </script>
</body>
</html>
